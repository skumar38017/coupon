name: deploycoupon

on:
  push:
    branches: [main]  # Trigger on push to main branch
  workflow_dispatch:
    inputs:
      branch:
        description: 'Deploy Coupon branch on Ubuntu server'
        required: true
        default: 'main'
        type: choice
        options:
          - main

permissions:
  contents: read
  actions: write

jobs:
  deploycoupon:
    runs-on: ubuntu-latest

    steps:
      # Set up SSH using the PEM key only if not already set up
      - name: Set up SSH
        run: |
          # Ensure .ssh directory exists for the runner's home directory
          if [ ! -d ~/.ssh ]; then
            echo "Creating .ssh directory..."
            mkdir -p ~/.ssh
          fi

          # Save the SSH private key from GitHub Secrets to the runner's ~/.ssh/coupon.pem
          echo "${{ secrets.UBUNTU_PRIVATE_KEY }}" > ~/.ssh/coupon.pem
          chmod 600 ~/.ssh/coupon.pem 

          # Add the server's SSH fingerprint to known_hosts to avoid SSH warning
          ssh-keyscan -H ec2-3-236-110-118.compute-1.amazonaws.com >> ~/.ssh/known_hosts

          # Debug the SSH setup by listing the .ssh contents
          pwd
          ls -la ~/.ssh

      # Delete old files and folders from the logged-in Ubuntu server
      - name: Delete old files and folders from logged-in Ubuntu server
        run: |
          ssh -i ~/.ssh/coupon.pem ubuntu@ec2-3-236-110-118.compute-1.amazonaws.com << 'EOF'
            rm -rf /home/ubuntu/coupon
            rm -rf /home/ubuntu/coupon.zip
            pwd
            ls -la
            echo "Old files deleted"
          EOF

      # Checkout the code
      - name: Checkout code
        run: |
          if [ ! -d "/home/ubuntu/coupon" ]; then
            echo "Cloning the repository..."
            git clone https://github.com/tagglab/coupon.git /home/ubuntu/coupon
            echo "Cloning complete"
          else
            echo "Repository already exists. Pulling the latest changes..."
            cd /home/ubuntu/coupon
            git pull origin main
            pwd
            ls -la
          fi

      # Delete previous files and folders from nginx server
      - name: Delete previous files and folders from nginx server
        run: |
          echo "Deleting previous files and folders..."
          sudo rm -rf /var/www/html/coupon
          sudo rm -rf /var/www/html/coupon.zip
          pwd
          ls -la

      # Copy files or folder into nginx server
      - name: Copy files or folder into nginx server
        run: |
          if [ ! -d "/var/www/html/coupon" ]; then
            echo "Copying the files..."
            sudo cp -r /home/ubuntu/coupon /var/www/html/
            pwd 
            ls -la
          else
            echo "Files already exist. Skipping copy."
            ls -la
          fi

      # Restart nginx server
      - name: Restart nginx server
        run: |
          echo "Restarting nginx server..."
          sudo systemctl restart nginx
