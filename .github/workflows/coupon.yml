name: deploycoupon

on:
  push:
    branches: [main]  # Trigger on push to main branch
  workflow_dispatch:
    inputs:
      branch:
        description: 'Deploy Coupon branch on Ubuntu server'
        required: true
        default: 'main'
        type: choice
        options:
          - main

permissions:
  contents: read
  actions: write

jobs:
  deploycoupon:
    runs-on: ubuntu-latest

    steps:
      # Set up SSH using the PEM key only if not already set up
      - name: Set up SSH
        run: |
          # Ensure the .ssh directory exists in the runner's home directory
          if [ ! -d ~/.ssh ]; then
            echo "Creating .ssh directory..."
            mkdir -p ~/.ssh
          fi

          # Check if coupon.pem exists, then set it up
          if [ ! -f ~/.ssh/coupon.pem ]; then
            echo "Setting up SSH key..."
            echo "${{ secrets.COUPON_SSH_KEY }}" > ~/.ssh/coupon.pem
            chmod 600 ~/.ssh/coupon.pem
          else
            echo "SSH key already set up, skipping setup."
          fi

          # Ensure known_hosts exists for SSH keyscan to work
          if [ ! -f ~/.ssh/known_hosts ]; then
            echo "Creating known_hosts file..."
            touch ~/.ssh/known_hosts
          fi

          # Add the server's SSH fingerprint to known_hosts
          ssh-keyscan -H ec2-3-236-110-118.compute-1.amazonaws.com >> ~/.ssh/known_hosts
          pwd
          ls -la ~/.ssh

      # Delete old files and folders from logged-in Ubuntu server
      - name: Delete old files and folders from logged-in Ubuntu server
        run: |
          ssh -i ~/.ssh/coupon.pem ubuntu@ec2-3-236-110-118.compute-1.amazonaws.com << 'EOF'
            rm -rf /home/ubuntu/coupon
            rm -rf /home/ubuntu/coupon.zip
            pwd
            ls -la
            echo "Old files deleted"
          EOF

      # Checkout the code
      - name: Checkout code
        run: |
          if [ ! -d "/home/ubuntu/coupon" ]; then
            echo "Cloning the repository..."
            git clone https://github.com/tagglab/coupon.git /home/ubuntu/coupon
            echo "Cloning complete"
          else
            echo "Repository already exists. Pulling the latest changes..."
            cd /home/ubuntu/coupon
            git pull origin main
            pwd
            ls -la
          fi

      # Delete previous files and folders from nginx server
      - name: Delete previous files and folders from nginx server
        run: |
          echo "Deleting previous files and folders..."
          sudo rm -rf /var/www/html/coupon
          sudo rm -rf /var/www/html/coupon.zip
          pwd
          ls -la

      # Copy file or folder into nginx server `/var/www/html`
      - name: Copy file or folder into nginx server
        run: |
          if [ ! -d "/var/www/html/coupon" ]; then
            echo "Copying the files..."
            sudo cp -r /home/ubuntu/coupon /var/www/html/
            pwd 
            ls -la
          else
            echo "Files already exist. Skipping copy."
            ls -la
          fi

      # Restart nginx server
      - name: Restart nginx server
        run: |
          echo "Restarting nginx server..."
          sudo systemctl restart nginx
